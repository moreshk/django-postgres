{% extends "base.html" %}

{% load static %}

{% block content %}
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">

<style>
    .invalid-input {
        border: 1px solid red;
    }
</style>

<div class="container mt-5">
    <h1>NAPLAN Essay Grader</h1>
    <div id="inputArea">
        <form id="essayForm">
            {% csrf_token %}            <div class="form-group">
                <label for="essayTypeInput">Essay type:</label>
                <select class="form-control" id="essayTypeInput">
                    <option>Narrative</option>
                    <option>Persuasive</option>
                </select>
            </div>
            <div class="form-group">
                <label for="gradeInput">Grade:</label>
                <select class="form-control" id="gradeInput">
                    <option>Grade 3</option>
                    <option>Grade 5</option>
                    <option>Grade 7</option>
                    <option>Grade 9</option>
                </select>
            </div>
            <datalist id="narrativeGrade3-5">
                <option value="The Magical Key">
                <option value="Lost in the Forest">
                <option value="The Mysterious Map">
                <option value="The Enchanted Painting">
                <option value="The Unexpected Visitor">
                <option value="The Time-Traveling Watch">
                <option value="The Talking Animal">
                <option value="The Hidden Diary">
                <option value="The Alien Encounter">
                <option value="The Mystery of the Disappearing Objects">

                    <!-- Add more options as needed -->
            </datalist>

            <datalist id="narrativeGrade7-9">
                <option value="The Time-Traveler's Dilemma">
                <option value="The Secret Society">
                <option value="The Last Survivors">
                <option value="The Virtual Reality Adventure">
                <option value="The Scientific Breakthrough">
                <option value="The Haunting of Hawthorn Manor">
                <option value="The Rebellion">
                <option value="The Interstellar Odyssey">
                <option value="The Art of Deception">
                <option value="The Lost Civilization">

                    <!-- Add more options as needed -->
            </datalist>

            <datalist id="persuasiveGrade3-5">
                <option value="Pets in Schools">
                <option value="The Importance of Outdoor Play">
                <option value="School Uniforms">
                <option value="Saving the Environment">
                <option value="Should Homework Be Abolished?">
                <option value="Healthy Eating Habits">
                <option value="The Benefits of Reading">
                <option value="The Importance of Kindness">
                <option value="The Use of Technology in Education">
                <option value="Reducing Screen Time">

                    <!-- Add more options as needed -->
            </datalist>

            <datalist id="persuasiveGrade7-9">
                <option value="The Impact of Social Media">
                <option value="The Value of Extracurricular Activities">
                <option value="The Importance of Critical Thinking">
                <option value="The Effects of Climate Change">
                <option value="The Role of Art and Creativity">
                <option value="The Impact of Technology on Relationships">
                <option value="The Value of Travel and Cultural Exchange">
                <option value="The Influence of Advertising">
                <option value="The Role of Youth in Civic Engagement">
                <option value="The Benefits of Multilingualism">
                    <!-- Add more options as needed -->
            </datalist>
            <div class="form-group">
                <label for="titleInput">Title:</label>
                <!-- <input type="text" class="form-control" id="titleInput" placeholder="Enter title"> -->
                <input list="titleOptions" type="text" class="form-control" id="titleInput" placeholder="Enter title">
                <!-- <datalist id="titleOptions">
                    <option value="Title 1">
                    <option value="Title 2">
                    <option value="Title 3">
                </datalist> -->
            </div>
            <div class="form-group">
                <label for="descriptionInput">Description:</label>
                <!-- <textarea class="form-control" id="descriptionInput" rows="5" -->
                <!-- placeholder="Enter description"></textarea> -->
                <input list="descriptionOptions" class="form-control" id="descriptionInput" rows="5"
                    placeholder="Enter description">
                <!-- <datalist id="descriptionOptions">
                    <option value="Description for Title 1">
                    <option value="Description for Title 2">
                    <option value="Description for Title 3">
                </datalist> -->
            </div>

            <div id="persuasiveGuidelines" class="container mt-4" style="display:none;">
                <h5 class="mt-4 mb-2">Start with an introduction.</h5>
                <p>An introduction lets a reader know what you are going to write about.</p>

                <h5 class="mt-4 mb-2">Write your reasons for your choice.</h5>
                <p>Why is it important for others to get involved in this activity? Explain your reasons.</p>

                <h5 class="mt-4 mb-2">Finish with a conclusion.</h5>
                <p>A conclusion sums up your reasons so that a reader is convinced of your opinion.</p>

                <h5 class="mt-4 mb-2">Remember to:</h5>
                <ul>
                    <li>plan your writing</li>
                    <li>use paragraphs to organise your ideas</li>
                    <li>write in sentences</li>
                    <li>choose your words carefully to convince a reader of your opinion</li>
                    <li>pay attention to your spelling and punctuation</li>
                    <li>check and edit your writing so it is clear.</li>
                </ul>
            </div>
            <div id="narrativeGuidelines" class="container mt-4">
                <h5 class="mt-4 mb-2">Think about:</h5>
                <ul>
                    <li>the characters in your story</li>
                    <li>when and where your story takes place</li>
                    <li>the complication or problem and how it is solved</li>
                    <li>how the story ends</li>
                </ul>

                <h5 class="mt-4 mb-2">Remember to:</h5>
                <ul>
                    <li>plan your story before you start</li>
                    <li>choose your words carefully</li>
                    <li>write in sentences</li>
                    <li>pay attention to your spelling, punctuation, and paragraphs</li>
                    <li>check and edit your writing</li>
                </ul>
            </div>

            <button type="button" class="btn btn-primary" onclick="submitForm()">Create Test</button>
        </form>
    </div>

    <div id="outputArea"
        style="display:none; background-color: #e9e9e9; padding: 15px; border-radius: 5px; margin-top: 20px;">
        <p><strong>Essay Type:</strong> <span id="essayTypeOutput"></span></p>
        <p><strong>Grade:</strong> <span id="gradeOutput"></span></p>
        <p><strong>Title:</strong> <span id="titleOutput"></span></p>
        <p><strong>Description:</strong> <span id="descriptionOutput"></span></p>
    </div>

    <div class="mt-2 text-left" id="refreshIcon" style="display:none;">
        <button onclick="resetForm()" class="btn btn-link">
            <i class="fas fa-redo-alt"></i>
        </button>
    </div>

    <div id="gradingArea" style="display:none;">
        <div class="form-group mt-4">
            <textarea class="form-control" id="gradingTextarea" rows="5"
                placeholder="Your text goes here ..."></textarea>
        </div>

        <button type="button" class="btn btn-primary" id="gradeButton" onclick="gradeText()">Submit Essay</button>
        <div class="spinner-border text-primary" role="status" id="loadingSpinner" style="display: none;">
            <span class="sr-only">Loading...</span>
        </div>
        <span id="loadingText"></span> <!-- Add this line -->
    </div>

    <div id="gradingOutput" style="margin-top: 20px;"></div>

</div>

<!-- Logout Link -->
<div class="mt-5 text-center">
    <a href="{% url 'logout' %}">Logout</a>
</div>

<script>
    function submitForm() {
        if (!validateForm()) {
            return; // Stop the function if validation fails
        }
        // Get the values
        let essayType = document.getElementById("essayTypeInput").value;
        let grade = document.getElementById("gradeInput").value;
        let title = document.getElementById("titleInput").value;
        let description = document.getElementById("descriptionInput").value;

        // Set the values in the output area
        document.getElementById("essayTypeOutput").textContent = essayType;
        document.getElementById("gradeOutput").textContent = grade;
        document.getElementById("titleOutput").textContent = title;
        document.getElementById("descriptionOutput").textContent = description;

        // Hide input fields
        document.getElementById("inputArea").style.display = "none";
        // Show output area
        document.getElementById("outputArea").style.display = "block";
        // Show refresh icon
        document.getElementById("refreshIcon").style.display = "block";

        let persuasiveGuidelines = document.getElementById("persuasiveGuidelines");
        let narrativeGuidelines = document.getElementById("narrativeGuidelines");

        if (essayType === "Persuasive") {
            persuasiveGuidelines.style.display = "block";
            narrativeGuidelines.style.display = "none";
        } else {
            persuasiveGuidelines.style.display = "none";
            narrativeGuidelines.style.display = "block";
        }

        let outputArea = document.getElementById("outputArea");
        let currentGuidelines = (document.getElementById("essayTypeInput").value === "Persuasive")
            ? document.getElementById("persuasiveGuidelines")
            : document.getElementById("narrativeGuidelines");

        let clonedGuidelines = currentGuidelines.cloneNode(true);
        outputArea.appendChild(clonedGuidelines);

        // Show gradingArea after form is submitted
        document.getElementById("gradingArea").style.display = "block";


    }


    function resetForm() {
        document.getElementById("inputArea").style.display = "block";
        document.getElementById("outputArea").style.display = "none";
        // Hide refresh icon
        document.getElementById("refreshIcon").style.display = "none";
        // document.getElementById("additionalInfo").value = "";
        // Reset dropdown to default and trigger the change event to display the appropriate guidelines
        let essayDropdown = document.getElementById("essayTypeInput");
        essayDropdown.selectedIndex = 0;
        essayDropdown.dispatchEvent(new Event('change'));
        // Hide gradingArea when form is reset
        document.getElementById("gradingArea").style.display = "none";
        // Remove the appended feedback (if exists) from outputArea
        let outputArea = document.getElementById("outputArea");
        let feedbackElement = outputArea.lastChild;
        if (feedbackElement && feedbackElement.nodeName === "DIV" && !feedbackElement.classList.contains('container')) {
            outputArea.removeChild(feedbackElement);
        }

        // Clear the gradingOutput content
        document.getElementById("gradingOutput").innerHTML = "";
    }

    document.getElementById("essayTypeInput").addEventListener("change", function () {
        let persuasiveGuidelines = document.getElementById("persuasiveGuidelines");
        let narrativeGuidelines = document.getElementById("narrativeGuidelines");

        if (this.value === "Persuasive") {
            persuasiveGuidelines.style.display = "block";
            narrativeGuidelines.style.display = "none";
        } else {
            persuasiveGuidelines.style.display = "none";
            narrativeGuidelines.style.display = "block";
        }

        let outputArea = document.getElementById("outputArea");
        let clonedGuidelines = outputArea.querySelector('.container.mt-4');
        if (clonedGuidelines) {
            outputArea.removeChild(clonedGuidelines);
        }
    });


    function validateForm() {
        let titleInput = document.getElementById("titleInput");
        let descriptionInput = document.getElementById("descriptionInput");

        // Check if the inputs are empty and highlight them if they are
        let isTitleEmpty = titleInput.value.trim() === "";
        let isDescriptionEmpty = descriptionInput.value.trim() === "";

        if (isTitleEmpty) {
            titleInput.classList.add("invalid-input");
        } else {
            titleInput.classList.remove("invalid-input");
        }

        if (isDescriptionEmpty) {
            descriptionInput.classList.add("invalid-input");
        } else {
            descriptionInput.classList.remove("invalid-input");
        }

        if (isTitleEmpty || isDescriptionEmpty) {
            alert("Both title and description must be filled out!");
            return false;
        }

        return true;
    }

    function gradeText() {
        // Show the spinner
        document.getElementById("loadingSpinner").style.display = "block";
        // Show the loading text
        document.getElementById("loadingText").textContent = "Please wait till the essay is processed, do not refresh or close this window while it is loading ...";

        let fetchPromises = [];
        let totalScore = 0;
        let maxScore = 0;

        let user_response = document.getElementById("gradingTextarea").value;
        let title = document.getElementById("titleOutput").textContent;
        let description = document.getElementById("descriptionOutput").textContent;
        let essay_type = document.getElementById("essayTypeOutput").textContent;
        let grade = document.getElementById("gradeOutput").textContent;

        let requestData = {
            user_response: user_response,
            title: title,
            description: description,
            essay_type: essay_type,
            grade: grade
        };

        console.log("first api call", requestData);
        fetchWithCounter('/v2essay_grader/grade_essay/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(requestData)
        })
            .then(response => response.json())
            .then(responseData => {
                let feedback = responseData.feedback;

                // Get the grading output div and clear its previous content
                let gradingOutputDiv = document.getElementById("gradingOutput");
                gradingOutputDiv.innerHTML = "";

                // Display the result in the grading output div
                let feedbackElement = document.createElement("div");
                feedbackElement.textContent = feedback;
                gradingOutputDiv.appendChild(feedbackElement);



                if (feedback === "Provided input is relevant to the title and description." && document.getElementById("essayTypeInput").value === "Persuasive") {

                    fetchPromises.push(
                        fetchWithCounter('/v2essay_grader/grade_essay_audience/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify(requestData) // 'data' should include the required parameters
                        })
                            .then(response => response.json())
                            .then(responseData => {
                                // Process the response data here

                                // Create a new header element
                                let headerElement1 = document.createElement("h4");
                                headerElement1.textContent = "Audience (Scored out of 6)";
                                gradingOutputDiv.appendChild(headerElement1);
                                console.log(responseData)
                                let grade_essay_audienceOutput = responseData.feedback;

                                // Use a regular expression to extract the score
                                let scoreRegex = /(\d+)\/(\d+)/;
                                let match = grade_essay_audienceOutput.match(scoreRegex);

                                if (match) {
                                    let achievedScore = parseInt(match[1]);
                                    let possibleScore = parseInt(match[2]);

                                    totalScore += achievedScore;
                                    maxScore += possibleScore;
                                }

                                // Display the result in the grading output div
                                let grade_essay_audienceElement = document.createElement("div");
                                grade_essay_audienceElement.innerHTML = grade_essay_audienceOutput;
                                gradingOutputDiv.appendChild(grade_essay_audienceElement);

                            })
                            .catch(error => {
                                console.error('Error:', error);
                            }));
                    // End of audience grading
                    // Make an AJAX call to the text structure grading function

                    fetchPromises.push(fetchWithCounter('/v2essay_grader/grade_essay_text_structure/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(requestData) // 'data' should include the required parameters
                    })
                        .then(response => response.json())
                        .then(responseData => {
                            // Create a new header element
                            let headerElement2 = document.createElement("h4");
                            headerElement2.textContent = "Text Structure (Scored out of 4)";
                            gradingOutputDiv.appendChild(headerElement2);
                            console.log(responseData)
                            let grade_essay_audienceOutput = responseData.feedback;

                            // Use a regular expression to extract the score
                            let scoreRegex = /(\d+)\/(\d+)/;
                            let match = grade_essay_audienceOutput.match(scoreRegex);

                            if (match) {
                                let achievedScore = parseInt(match[1]);
                                let possibleScore = parseInt(match[2]);

                                totalScore += achievedScore;
                                maxScore += possibleScore;
                            }

                            console.log("totalScore: ", totalScore);

                            // Display the result in the grading output div
                            let grade_essay_audienceElement = document.createElement("div");
                            grade_essay_audienceElement.innerHTML = grade_essay_audienceOutput;
                            gradingOutputDiv.appendChild(grade_essay_audienceElement);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        }));
                    // End of text structure grading
                    // Make an AJAX call to the Ideas grading function

                    fetchPromises.push(fetchWithCounter('/v2essay_grader/grade_essay_ideas/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(requestData) // 'data' should include the required parameters
                    })
                        .then(response => response.json())
                        .then(responseData => {
                            // Create a new header element
                            let headerElement3 = document.createElement("h4");
                            headerElement3.textContent = "Ideas (Scored out of 5)";
                            gradingOutputDiv.appendChild(headerElement3);
                            console.log(responseData)
                            let grade_essay_audienceOutput = responseData.feedback;

                            // Use a regular expression to extract the score
                            let scoreRegex = /(\d+)\/(\d+)/;
                            let match = grade_essay_audienceOutput.match(scoreRegex);

                            if (match) {
                                let achievedScore = parseInt(match[1]);
                                let possibleScore = parseInt(match[2]);

                                totalScore += achievedScore;
                                maxScore += possibleScore;
                            }

                            console.log("totalScore: ", totalScore);

                            // Display the result in the grading output div
                            let grade_essay_audienceElement = document.createElement("div");
                            grade_essay_audienceElement.innerHTML = grade_essay_audienceOutput;
                            gradingOutputDiv.appendChild(grade_essay_audienceElement);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        }));
                    // End of Ideas grading
                    // Make an AJAX call to the Persuasive Devices grading function

                    fetchPromises.push(fetchWithCounter('/v2essay_grader/grade_essay_persuasive_devices/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(requestData) // 'data' should include the required parameters
                    })
                        .then(response => response.json())
                        .catch(error => {
                            console.error('Error:', error);
                        }));
                    // End of Persuasive devices grading

                    // Make an AJAX call to the vocabulary grading function

                    fetchPromises.push(fetchWithCounter('/v2essay_grader/grade_essay_vocabulary/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(requestData) // 'data' should include the required parameters
                    })
                        .then(response => response.json())

                        .catch(error => {
                            console.error('Error:', error);
                        }));
                    // End of vocabulary grading

                    // Make an AJAX call to the cohesion grading function

                    fetchPromises.push(fetchWithCounter('/v2essay_grader/grade_essay_cohesion/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(requestData) // 'data' should include the required parameters
                    })
                        .then(response => response.json())

                        .catch(error => {
                            console.error('Error:', error);
                        }));
                    // End of cohesion grading

                    // Make an AJAX call to the paragraphing grading function

                    fetchPromises.push(fetchWithCounter('/v2essay_grader/grade_essay_paragraphing/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(requestData) // 'data' should include the required parameters
                    })
                        .then(response => response.json())

                        .catch(error => {
                            console.error('Error:', error);
                        }));
                    // End of paragraphing grading

                    // Make an AJAX call to the grade_essay_sentence_structure grading function

                    fetchPromises.push(fetchWithCounter('/v2essay_grader/grade_essay_sentence_structure/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(requestData) // 'data' should include the required parameters
                    })
                        .then(response => response.json())

                        .catch(error => {
                            console.error('Error:', error);
                        }));
                    // End of Sentence Structure

                    // Make an AJAX call to the grade_essay_punctuation grading function

                    fetchPromises.push(fetchWithCounter('/v2essay_grader/grade_essay_punctuation/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(requestData) // 'data' should include the required parameters
                    })
                        .then(response => response.json())

                        .catch(error => {
                            console.error('Error:', error);
                        }));
                    // End of grade_essay_punctuation grading

                    // Make an AJAX call to the grade_essay_spelling grading function

                    fetchPromises.push(fetchWithCounter('/v2essay_grader/grade_essay_spelling/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(requestData) // 'data' should include the required parameters
                    })
                        .then(response => response.json())

                        .catch(error => {
                            console.error('Error:', error);
                        }));
                    // End of grade_essay_spelling grading


                }

                // Narrative Grading

                if (feedback === "Provided input is relevant to the title and description." && document.getElementById("essayTypeInput").value === "Narrative") {

                    fetchPromises.push(fetchWithCounter('/v2essay_grader/grade_narrative_audience/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(requestData) // 'data' should include the required parameters
                    })
                        .then(response => response.json())

                        .catch(error => {
                            console.error('Error:', error);
                        }));
                    // End of grade_narrative_audience grading

                    // 2.2. Make an AJAX call to the grade_narrative_text_structure grading function

                    fetchPromises.push(fetchWithCounter('/v2essay_grader/grade_narrative_text_structure/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(requestData) // 'data' should include the required parameters
                    })
                        .then(response => response.json())

                        .catch(error => {
                            console.error('Error:', error);
                        }));
                    // End of grade_narrative_text_structure grading

                    // 2.3. Make an AJAX call to the grade_narrative_ideas grading function

                    fetchPromises.push(fetchWithCounter('/v2essay_grader/grade_narrative_ideas/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(requestData) // 'data' should include the required parameters
                    })
                        .then(response => response.json())

                        .catch(error => {
                            console.error('Error:', error);
                        }));
                    // End of grade_narrative_text_structure grading

                    // 2.4. Make an AJAX call to the grade_narrative_setting grading function
                    fetchPromises.push(fetchWithCounter('/v2essay_grader/grade_narrative_setting/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(requestData) // 'data' should include the required parameters
                    })
                        .then(response => response.json())

                        .catch(error => {
                            console.error('Error:', error);
                        }));
                    // End of grade_narrative_text_structure grading

                    // 2.5 Make an AJAX call to the vocabulary grading function

                    fetchPromises.push(fetchWithCounter('/v2essay_grader/grade_essay_vocabulary/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(requestData) // 'data' should include the required parameters
                    })
                        .then(response => response.json())

                        .catch(error => {
                            console.error('Error:', error);
                        }));
                    // End of vocabulary grading

                    // 2.6 Make an AJAX call to the narrative cohesion grading function

                    fetchPromises.push(fetchWithCounter('/v2essay_grader/grade_narrative_cohesion/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(requestData) // 'data' should include the required parameters
                    })
                        .then(response => response.json())

                        .catch(error => {
                            console.error('Error:', error);
                        }));
                    // End of vocabulary grading

                    // 2.7 Make an AJAX call to the paragraphing grading function

                    fetchPromises.push(fetchWithCounter('/v2essay_grader/grade_essay_paragraphing/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(requestData) // 'data' should include the required parameters
                    })
                        .then(response => response.json())

                        .catch(error => {
                            console.error('Error:', error);
                        }));
                    // End of paragraphing grading

                    // 2.8 Make an AJAX call to the grade_essay_sentence_structure grading function

                    fetchPromises.push(fetchWithCounter('/v2essay_grader/grade_essay_sentence_structure/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(requestData) // 'data' should include the required parameters
                    })
                        .then(response => response.json())

                        .catch(error => {
                            console.error('Error:', error);
                        }));
                    // End of Sentence Structure

                    // 2.9 Make an AJAX call to the grade_essay_punctuation grading function

                    fetchPromises.push(fetchWithCounter('/v2essay_grader/grade_essay_punctuation/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(requestData) // 'data' should include the required parameters
                    })
                        .then(response => response.json())

                        .catch(error => {
                            console.error('Error:', error);
                        }));
                    // End of grade_essay_punctuation grading



                    // 2.10. Make an AJAX call to the grade_essay_spelling grading function

                    fetchPromises.push(fetchWithCounter('/v2essay_grader/grade_essay_spelling/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(requestData) // 'data' should include the required parameters
                    })
                        .then(response => response.json())

                        .catch(error => {
                            console.error('Error:', error);
                        }));
                    // End of grade_essay_spelling grading

                }

                // After all API calls
                Promise.all(fetchPromises)
                    .then(() => {
                        // Get the grading output div and clear its previous content
                        let gradingOutputDiv = document.getElementById("gradingOutput");
                        gradingOutputDiv.innerHTML = "";

                        // Clear the loading text
                        document.getElementById("loadingText").textContent = "";

                        // Display the result in the grading output div
                        let finalMessageElement = document.createElement("div");
                        finalMessageElement.textContent = "Your essay has been successfully submitted";
                        gradingOutputDiv.appendChild(finalMessageElement);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });

            })
            .catch(error => {
                console.error('Error:', error);
            });

        // Hide the spinner
        document.getElementById("loadingSpinner").style.display = "none";
    }

    document.getElementById("titleInput").addEventListener("input", function () {
        let title = this.value;
        let descriptionInput = document.getElementById("descriptionInput");

        switch (title) {
            case "The Magical Key":
                descriptionInput.value = "Imagine if a character found a magical key that could unlock any door in the world. Write a narrative (story) about the adventures this character has while using the key. You can create your own character and describe the amazing places they visit or the mysteries they uncover.";
                break;

            case "Lost in the Forest":
                descriptionInput.value = "Today you are going to write a narrative (story) called 'Lost in the Forest.' Your story could be about a group of friends who get lost in a dense forest during a camping trip. Describe the challenges they face, the discoveries they make, and how they eventually find their way back home.";
                break;

            case "The Mysterious Map":
                descriptionInput.value = "Today you are going to write a narrative (story) about 'The Mysterious Map.' Your story should revolve around a character who stumbles upon an old, tattered map. What does the map lead to? Who or what do they meet on their journey to uncover the map's secrets?";
                break;

            case "The Enchanted Painting":
                descriptionInput.value = "Imagine if a character found a magical painting that could transport them into the world inside the artwork. Write a narrative (story) about the adventures they have within the painting. What do they see, hear, and experience in this enchanting world?";
                break;

            case "The Unexpected Visitor":
                descriptionInput.value = "Today you are going to write a narrative (story) about an 'Unexpected Visitor.' Your story might be about a surprise visit from a long-lost friend or a mysterious stranger. Describe the interactions, emotions, and events that unfold during this unexpected encounter.";
                break;

            case "The Time-Traveling Watch":
                descriptionInput.value = "Imagine if a character found a special watch that allowed them to travel through time. Write a narrative (story) about the adventures they have as they journey to different time periods. What historical events do they witness, and how do they use this unique ability?";
                break;

            case "The Talking Animal":
                descriptionInput.value = "Today you are going to write a narrative (story) called 'The Talking Animal.' Your story could be about a character who discovers an animal that can speak. Describe the conversations they have, the lessons they learn, and the bond that forms between them.";
                break;

            case "The Hidden Diary":
                descriptionInput.value = "Today you are going to write a narrative (story) about 'The Hidden Diary.' Your story should follow a character who stumbles upon an old diary filled with secrets. What do they uncover as they read through its pages, and how does it impact their life?";
                break;

            case "The Alien Encounter":
                descriptionInput.value = "Imagine if a character had an encounter with an alien from another planet. Write a narrative (story) about this extraordinary meeting. Describe the alien's appearance, their communication, and the adventures that unfold as the character and the alien interact.";
                break;

            case "The Mystery of the Disappearing Objects":
                descriptionInput.value = "Today you are going to write a narrative (story) about 'The Mystery of the Disappearing Objects.' Your story could be about a series of strange events where objects keep disappearing in a small town. How do the residents come together to solve this mystery, and what do they discover in the end?";
                break;

            case "The Time-Traveler's Dilemma":
                descriptionInput.value = "Imagine a character who possesses a time-travel device that can only be used once to change a single event in history. Write a narrative about the character's decision, the event they choose to alter, and the consequences that follow.";
                break;

            case "The Secret Society":
                descriptionInput.value = "Your task is to write a narrative about a character who stumbles upon a secret society with mysterious rituals and hidden agendas. Describe the character's journey into this clandestine world and the challenges they face in uncovering its secrets.";
                break;

            case "The Last Survivors":
                descriptionInput.value = "In a post-apocalyptic world, your story should focus on the last survivors trying to rebuild society. Write a narrative about their struggles, the choices they make, and the hope they hold onto for a better future.";
                break;

            case "The Virtual Reality Adventure":
                descriptionInput.value = "Imagine a world where virtual reality technology is so advanced that it becomes indistinguishable from reality. Write a narrative about a character who embarks on an unforgettable adventure within this virtual world, blurring the lines between the real and the virtual.";
                break;

            case "The Scientific Breakthrough":
                descriptionInput.value = "Your narrative should revolve around a brilliant young scientist who makes a groundbreaking discovery with the potential to change the world. Describe the character's journey, the challenges they face, and the ethical dilemmas posed by their discovery.";
                break;

            case "The Haunting of Hawthorn Manor":
                descriptionInput.value = "Write a narrative about a character who moves into a centuries-old mansion rumored to be haunted. Describe the eerie events, the character's investigation, and the ultimate revelation of the mansion's secrets.";
                break;

            case "The Rebellion":
                descriptionInput.value = "In a dystopian society, write a narrative about a group of rebels fighting against a repressive regime. Explore the characters' motivations, their strategies, and the risks they take to challenge the status quo.";
                break;

            case "The Interstellar Odyssey":
                descriptionInput.value = "Imagine a future where humans have colonized other planets in distant galaxies. Write a narrative about a space explorer's journey to a far-off world, their encounters with alien life forms, and the challenges of interstellar travel.";
                break;

            case "The Art of Deception":
                descriptionInput.value = "Your narrative should feature a masterful con artist who uses wit and cunning to achieve their goals. Describe their elaborate schemes, the people they manipulate, and the moral dilemmas they face along the way.";
                break;

            case "The Lost Civilization":
                descriptionInput.value = "Write a narrative about an archaeologist who discovers the remnants of a lost civilization deep in an unexplored jungle. Explore the character's excitement, the mysteries they uncover, and the ethical questions raised by their findings.";
                break;

            case "Pets in Schools":
                descriptionInput.value = "Some people believe that schools should have pets, like dogs or cats, to help students learn about responsibility and animal care. Others think that pets in schools can be distracting and may cause allergies in some students. What do you think? Write a persuasive essay to convince others whether or not schools should have pets.";
                break;
            case "The Importance of Outdoor Play":
                descriptionInput.value = "Many children spend a lot of time indoors watching TV or playing video games. Do you think it's important for kids to play outside? Write a persuasive essay explaining why outdoor play is important for physical and mental health.";
                break;
            case "School Uniforms":
                descriptionInput.value = "Some schools require students to wear uniforms, while others do not. Do you think students should wear uniforms to school? Write a persuasive essay discussing the advantages or disadvantages of school uniforms.";
                break;
            case "Saving the Environment":
                descriptionInput.value = "The environment is important, and there are many ways people can help protect it. Write a persuasive essay explaining why it's essential to take care of the environment and suggesting actions that people can take to make a positive impact.";
                break;
            case "Should Homework Be Abolished?":
                descriptionInput.value = "Some students believe that homework should be abolished because it takes up their free time, while others think homework is important for learning. Write a persuasive essay arguing for or against the idea of abolishing homework.";
                break;
            case "Healthy Eating Habits":
                descriptionInput.value = "Eating healthy foods is important for our well-being. Write a persuasive essay encouraging your classmates to make healthier food choices and explaining the benefits of a balanced diet.";
                break;
            case "The Benefits of Reading":
                descriptionInput.value = "Reading is a valuable activity that can expand our knowledge and imagination. Write a persuasive essay to convince your friends why they should spend more time reading books, magazines, or other materials.";
                break;
            case "The Importance of Kindness":
                descriptionInput.value = "Kindness is a quality that makes the world a better place. Write a persuasive essay explaining why it's important to be kind to others and suggesting ways people can show kindness in their daily lives.";
                break;
            case "The Use of Technology in Education":
                descriptionInput.value = "Technology is becoming more common in schools. Do you think technology helps or hinders learning? Write a persuasive essay arguing your point of view on the use of technology in education.";
                break;
            case "Reducing Screen Time":
                descriptionInput.value = "Many children spend a lot of time in front of screens, such as computers, tablets, and TVs. Do you think kids should reduce their screen time? Write a persuasive essay discussing the benefits of limiting screen time and suggesting alternative activities.";
                break;
            case "The Impact of Social Media":
                descriptionInput.value = "Social media is a powerful tool that can influence our lives in many ways. Write a persuasive essay discussing the positive and negative impacts of social media on society, and argue whether individuals should use it responsibly.";
                break;
            case "The Value of Extracurricular Activities":
                descriptionInput.value = "Extracurricular activities, such as sports, clubs, and volunteering, can enhance a student's overall education. Write a persuasive essay explaining why participating in extracurricular activities is valuable for personal growth and development.";
                break;
            case "The Importance of Critical Thinking":
                descriptionInput.value = "Critical thinking is a skill that allows us to analyze information, make informed decisions, and solve complex problems. Write a persuasive essay discussing the significance of critical thinking in education and daily life.";
                break;
            case "The Effects of Climate Change":
                descriptionInput.value = "Climate change is a global issue with far-reaching consequences. Write a persuasive essay addressing the importance of addressing climate change, and argue for actions individuals and governments should take to combat it.";
                break;
            case "The Role of Art and Creativity":
                descriptionInput.value = "Art and creativity play a vital role in our world. Write a persuasive essay explaining why art education and the promotion of creativity are essential for personal development and society as a whole.";
                break;
            case "The Impact of Technology on Relationships":
                descriptionInput.value = "Technology has transformed how we communicate and interact with others. Write a persuasive essay discussing the effects of technology on personal relationships and argue whether it has brought people closer together or driven them apart.";
                break;
            case "The Value of Travel and Cultural Exchange":
                descriptionInput.value = "Traveling and experiencing other cultures can be a valuable educational experience. Write a persuasive essay explaining why it's essential for students to have opportunities for travel and cultural exchange.";
                break;
            case "The Influence of Advertising":
                descriptionInput.value = "Advertising is everywhere, shaping our opinions and choices. Write a persuasive essay discussing the impact of advertising on consumer behavior and argue whether there should be stricter regulations on advertising practices.";
                break;
            case "The Role of Youth in Civic Engagement":
                descriptionInput.value = "Civic engagement involves young people actively participating in their communities and governments. Write a persuasive essay encouraging youth to get involved in civic activities and explaining the positive effects of their engagement.";
                break;
            case "The Benefits of Multilingualism":
                descriptionInput.value = "Being able to speak multiple languages is a valuable skill in a globalized world. Write a persuasive essay explaining the advantages of being multilingual and arguing for the importance of language education.";
                break;


            default:
                descriptionInput.value = "";
        }
    });

    document.getElementById("essayTypeInput").addEventListener("change", updateTitleOptions);
    document.getElementById("gradeInput").addEventListener("change", updateTitleOptions);

    function updateTitleOptions() {
        let essayType = document.getElementById("essayTypeInput").value;
        let grade = document.getElementById("gradeInput").value;
        let titleInput = document.getElementById("titleInput");

        if (essayType === "Narrative" && (grade === "Grade 3" || grade === "Grade 5")) {
            titleInput.setAttribute("list", "narrativeGrade3-5");
        } else if (essayType === "Narrative" && (grade === "Grade 7" || grade === "Grade 9")) {
            titleInput.setAttribute("list", "narrativeGrade7-9");
        } else if (essayType === "Persuasive" && (grade === "Grade 3" || grade === "Grade 5")) {
            titleInput.setAttribute("list", "persuasiveGrade3-5");
        } else if (essayType === "Persuasive" && (grade === "Grade 7" || grade === "Grade 9")) {
            titleInput.setAttribute("list", "persuasiveGrade7-9");
        } else {
            titleInput.removeAttribute("list");
        }
    }

    // Call the function immediately to set the correct datalist when the page loads
    updateTitleOptions();

    let activeApiCalls = 0;

    function updateStatus() {
        let gradeButton = document.getElementById("gradeButton");
        let loadingSpinner = document.getElementById("loadingSpinner");

        if (activeApiCalls > 0) {
            gradeButton.disabled = true;
            loadingSpinner.style.display = "block";
        } else {
            gradeButton.disabled = false;
            loadingSpinner.style.display = "none";
        }
    }

    function fetchWithCounter(url, options) {
        activeApiCalls++;
        updateStatus();

        return fetch(url, options)
            .then(response => {
                activeApiCalls--;
                updateStatus();
                return response;
            })
            .catch(error => {
                activeApiCalls--;
                updateStatus();
                throw error;
            });
    }
</script>

{% endblock %}