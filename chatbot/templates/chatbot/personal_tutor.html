{% extends 'base.html' %}

{% block content %}
<style>
    #messages-container {
        height: calc(100vh - 250px);
        /* Adjust the 120px to fit your input field and any other elements */
        overflow-y: auto;
        padding: 10px;
        background-color: #f8f9fa;
        /* Light grey background */
    }

    .message {
        padding: 5px 10px;
        margin-bottom: 10px;
        border-radius: 20px;
        clear: both;
        /* Ensure each message is on a new line */
    }

    .user-message {
        background-color: #007bff;
        /* Bootstrap primary color */
        color: white;
        float: right;
        /* Float the bubble to the right */
    }

    .bot-message {
        background-color: #e9ecef;
        /* Bootstrap secondary color */
        color: black;
        float: left;
        /* Float the bubble to the left */
    }

    .clearfix::after {
        content: "";
        clear: both;
        display: table;
    }

    #input-container {
        position: relative;
        /* Ensure this is set to relative */
        padding: 10px;
        margin-bottom: 20px;
        /* Add space for the spinner */
    }

    #spinner {
        position: absolute;
        /* Keep this as absolute */
        bottom: 100%;
        /* Position the spinner above the input field */
        left: 50%;
        /* Center horizontally */
        transform: translateX(-50%);
        /* Center horizontally */
        display: none;
    }

    .preset-btn {
        margin: 0 5px;
        border-radius: 15px;
        /* Rounded corners */
        border: none;
        /* Remove borders for a flat look */
        color: #333;
        /* Button text color */
        background-color: #f0f0f0;
        /* Button background color */
        padding: 5px 15px;
        /* Padding inside the button */
        cursor: pointer;
        /* Change cursor to pointer on hover */
        outline: none;
        /* Remove the outline to maintain the flat look */
        transition: background-color 0.3s;
        /* Smooth background color transition */
    }

    .preset-btn:hover {
        background-color: #e0e0e0;
        /* Slightly darker on hover */
    }

    @media (max-width: 576px) {

        /* Adjust for mobile devices */
        #messages-container {
            height: calc(100vh - 300px);
            /* Further increase if necessary for mobile screens */
        }
    }
</style>

<div id="messages-container">
    <!-- Dynamically load messages here -->
</div>

<div id="preset-messages" style="text-align: center; padding: 10px;">
    <button class="preset-btn" onclick="sendPresetMessage('Yes')">Yes</button>
    <button class="preset-btn" onclick="sendPresetMessage('Continue')">Continue</button>
    <button class="preset-btn" onclick="sendPresetMessage('I have a question')">I have a question</button>
    <button class="preset-btn" onclick="sendPresetMessage('No')">No</button>
</div>

<div id="input-container">
    <div id="spinner" class="text-center">
        <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>

    <form id="chat-form">
        <div class="input-group mb-3">
            <input type="text" class="form-control" placeholder="Type a message..." id="user-input">
            <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="submit">Send</button>
            </div>
        </div>
    </form>
</div>

<script>

    function togglePresetButtons(disabled) {
        const presetButtons = document.querySelectorAll('.preset-btn');
        presetButtons.forEach(button => {
            button.disabled = disabled;
        });
    }

    function toggleSpinner(show) {
        const spinner = document.getElementById('spinner');
        spinner.style.display = show ? 'block' : 'none';
    }

    function toggleInputField(disabled) {
        const userInputField = document.getElementById('user-input');
        userInputField.disabled = disabled;
        if (!disabled) {
            userInputField.focus();
        }
    }

    document.addEventListener('DOMContentLoaded', (event) => {
        sendStartMessage();
    });

    function sendStartMessage() {
        const startMessage = 'start';
        const postData = JSON.stringify({ message: startMessage });

        toggleSpinner(true); // Show spinner
        toggleInputField(true); // Disable input field
        togglePresetButtons(true); // Disable preset buttons

        fetch('/chatbot/personal-tutor/chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: postData
        })
            .then(response => response.json())
            .then(data => {
                toggleSpinner(false); // Hide spinner
                toggleInputField(false); // Enable input field
                togglePresetButtons(false);
                if (data.error) {
                    console.error('Error:', data.error);
                } else {
                    appendMessage('bot', data.response);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                toggleSpinner(false); // Hide spinner
                toggleInputField(false); // Enable input field
                togglePresetButtons(false);
            });
    }


    // Function to update preset buttons dynamically and conditionally show 'I have a question'
    function updatePresetButtons(options, skipQuestionPreset = false) {
        const presetContainer = document.getElementById('preset-messages');
        presetContainer.innerHTML = '';

        // Add dynamic options if any
        options.forEach(option => {
            const button = document.createElement('button');
            button.textContent = option;
            button.className = 'preset-btn';
            button.onclick = function () { sendPresetMessage(option); };
            presetContainer.appendChild(button);
        });

        // Only add 'I have a question' if not skipping it
        if (!skipQuestionPreset) {
            const questionButton = document.createElement('button');
            questionButton.textContent = 'I have a question';
            questionButton.className = 'preset-btn';
            questionButton.onclick = function () { sendPresetMessage('I have a question'); };
            presetContainer.appendChild(questionButton);
        }


    }

    let currentAudio = null;  // This will reference the currently playing Audio object

    // Function to call the server-side Text-to-Speech endpoint
    function fetchTextToSpeech(message) {
        // Stop any currently playing audio
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;  // Reset the audio play time
        }

        const postData = JSON.stringify({ text: message });

        fetch('/chatbot/text-to-speech/', {  // Update with the correct URL to your view
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: postData
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                // The response is a stream, so we get the reader from the response body
                const reader = response.body.getReader();

                // We'll stream the audio as chunks are received
                return new ReadableStream({
                    start(controller) {
                        function push() {
                            // Read a chunk of data
                            reader.read().then(({ done, value }) => {
                                if (done) {
                                    // If done, close the stream
                                    controller.close();
                                    return;
                                }
                                // Enqueue the chunk into our stream
                                controller.enqueue(value);
                                push();
                            }).catch(error => {
                                console.error('Stream reading error:', error);
                                controller.error(error);
                            });
                        }
                        push();
                    }
                });
            })
            .then(stream => {
                // Create a new response out of the stream
                return new Response(stream);
            })
            .then(response => {
                // Create an object URL for the audio stream
                return response.blob();
            })
            .then(blob => {
                // Create an audio element and play the blob as soon as it's loaded
                const audioUrl = URL.createObjectURL(blob);
                currentAudio = new Audio(audioUrl);
                currentAudio.play().catch(error => console.error('Error playing audio:', error));
            })
            .catch(error => {
                console.error('Text-to-Speech fetch error:', error);
            });
    }

    // Function to stop the currently playing audio
    function stopCurrentAudio() {
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
        }
    }


    // Modify the appendMessage function to handle dynamic options and text-to-speech
    function appendMessage(role, content) {
        const messagesContainer = document.getElementById('messages-container');
        const messageDiv = document.createElement('div');
        const clearfixDiv = document.createElement('div'); // Clearfix div


        // Check if the message is from the bot and contains options
        if (role === 'bot') {
            const optionsMatch = content.match(/Options:(.*)/);
            if (optionsMatch) {
                // Extract options and create an array
                const options = optionsMatch[1].split(',').map(option => option.trim().replace(/\.$/, ''));
                updatePresetButtons(options);
                // Trim the content to remove the options text
                content = content.replace(/Options:.*$/, '').trim();
            } else {
                // If no options are present, decide whether to show 'I have a question'
                const skipQuestionPreset = sessionStorage.getItem('skipQuestionPreset') === 'true';
                updatePresetButtons([], skipQuestionPreset);
                // Reset the flag after showing the message
                sessionStorage.removeItem('skipQuestionPreset');
            }
            // let textToSpeak = content; // Text that will be sent to the text-to-speech service

            // Call the server-side Text-to-Speech endpoint with the full message content
            fetchTextToSpeech(content);
        }

        messageDiv.classList.add('message', role === 'user' ? 'user-message' : 'bot-message');
        messageDiv.textContent = content;

        clearfixDiv.classList.add('clearfix'); // Add clearfix class

        messagesContainer.appendChild(messageDiv);
        messagesContainer.appendChild(clearfixDiv); // Append clearfix after the message
        messagesContainer.scrollTop = messagesContainer.scrollHeight; // Scroll to the latest message
    }


    // Function to handle form submission
    function handleFormSubmit(event) {
        event.preventDefault();
        stopCurrentAudio();
        const userInputField = document.getElementById('user-input');
        const userMessage = userInputField.value.trim();

        if (userMessage) {
            appendMessage('user', userMessage);
            toggleSpinner(true); // Show spinner
            toggleInputField(true); // Disable input field
            togglePresetButtons(true);

            // Prepare the data to be sent in the POST request
            const postData = JSON.stringify({ message: userMessage });

            // Make the AJAX call to the server
            fetch('/chatbot/personal-tutor/chat/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: postData
            })
                .then(response => response.json())
                .then(data => {
                    toggleSpinner(false); // Hide spinner
                    toggleInputField(false); // Enable input field
                    togglePresetButtons(false);

                    if (data.error) {
                        console.error('Error:', data.error);
                    } else {
                        // Append the chatbot's response to the container
                        appendMessage('bot', data.response);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    toggleSpinner(false); // Hide spinner
                    toggleInputField(false); // Enable input field
                    togglePresetButtons(false);
                });

            // Clear the input field after sending the message
            userInputField.value = '';
        }
    }

    // Function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Add event listener to the form
    document.getElementById('chat-form').addEventListener('submit', handleFormSubmit);


    // Function to send a preset message
    function sendPresetMessage(message) {
        const postData = JSON.stringify({ message: message });

        // Set a flag if 'I have a question' is sent
        if (message === 'I have a question') {
            sessionStorage.setItem('skipQuestionPreset', 'true');
        }

        appendMessage('user', message); // Append the user message
        toggleSpinner(true); // Show spinner
        toggleInputField(true); // Disable input field
        togglePresetButtons(true); // Disable preset buttons <-- This should be true to disable

        // Make the AJAX call to the server
        fetch('/chatbot/personal-tutor/chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: postData
        })
            .then(response => response.json())
            .then(data => {
                toggleSpinner(false); // Hide spinner
                toggleInputField(false); // Enable input field
                togglePresetButtons(false); // Enable preset buttons <-- This should be false to enable
                if (data.error) {
                    console.error('Error:', data.error);
                } else {
                    appendMessage('bot', data.response); // Append the bot's response
                }
            })
            .catch(error => {
                console.error('Error:', error);
                toggleSpinner(false); // Hide spinner
                toggleInputField(false); // Enable input field
                togglePresetButtons(false); // Enable preset buttons <-- This should be false to enable
            });
    }
</script>
{% endblock %}